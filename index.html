<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta name="google-site-verification" content="Tub7yzYBSg28Cnb8qypEZk1RLwlbnkuoBRcmbRnepXg" />
  <meta charset="UTF-8" />
<title>Ø§Ø­Ø¨Ùƒ</title>
<style>
:root {
  --primary-color: #ff5aad;
  --secondary-color: #ff77a9;
  --sent-msg: #87cefa;
  --received-msg: #32cd32;
  --bg-dark: #1f2124;
  --bg-header: #2a2f3a;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg-dark);
  color: white;
  direction: rtl;
  overflow: hidden;
}

.chat-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  background: var(--bg-header);
  padding: 10px 15px;
  display: flex;
  align-items: center;
  gap: 15px;
  position: relative;
  flex-shrink: 0;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary-color);
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 20px;
  color: white;
  flex-shrink: 0;
}

.user-info {
  flex-grow: 1;
  min-width: 0;
}

.user-name {
  font-weight: bold;
  font-size: 16px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--secondary-color);
}

#status {
  font-size: 12px;
  color: #ffabc2;
  font-style: italic;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª */
#call-btn, #video-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  font-size: 20px;
  cursor: pointer;
  background: none;
  border: none;
  color: white;
  margin-left: 5px;
  transition: transform 0.2s;
}

#video-btn { left: 50px; }

#call-btn:hover, #video-btn:hover {
  transform: scale(1.1);
}

/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
#chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px 15px;
  background: linear-gradient(135deg, #ffdde1, #f3ec78);
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 10px;
  will-change: transform;
  transform: translateZ(0);
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.message {
  margin-bottom: 12px;
  max-width: 70%;
  padding: 10px 15px;
  border-radius: 20px;
  font-size: 14px;
  line-height: 1.4;
  word-break: break-word;
  position: relative;
  display: flex;
  flex-direction: column;
  animation: messageAppear 0.2s ease-out;
  transform: translateZ(0);
  will-change: transform, opacity;
}

@keyframes messageAppear {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© (Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) */
.message.sent {
  background: var(--sent-msg);
  align-self: flex-end;
  border-bottom-right-radius: 5px;
  margin-left: auto;
}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© (Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±) */
.message.recv {
  background: var(--received-msg);
  align-self: flex-start;
  border-bottom-left-radius: 5px;
  margin-right: auto;
}

.message .timestamp {
  font-size: 10px;
  color: #666;
  display: block;
  margin-top: 5px;
  text-align: left;
}

.message.sent .timestamp {
  text-align: right;
}

.message::before {
  content: "â™¥";
  position: absolute;
  top: -8px;
  font-size: 14px;
  color: #ff77aa;
}

.message.sent::before {
  left: -8px;
}

.message.recv::before {
  right: -8px;
}

main::before {
  content: "â™¥  Ù‚Ù„Ø¨ÙŠ Ù…Ø³ÙƒÙ†ÙŠÙƒ Ø¬Ù†ÙˆØ±ØªÙŠâ™¥";
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  color: #ff7799cc;
  font-weight: bold;
  font-size: 14px;
  text-shadow: 0 0 3px #ff0055cc;
  letter-spacing: 1.2px;
  pointer-events: none;
}

footer {
  background: var(--bg-header);
  padding: 10px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-shrink: 0;
}

input[type="text"] {
  flex-grow: 1;
  border-radius: 22px;
  border: none;
  padding: 10px 15px;
  background: #20262f;
  color: white;
  font-size: 14px;
  outline: none;
  transition: all 0.2s;
}

input[type="text"]:focus {
  box-shadow: 0 0 0 2px var(--primary-color);
}

button.send-btn {
  background: var(--primary-color);
  border: none;
  padding: 8px 15px;
  border-radius: 20px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  transition: all 0.2s;
  transform: translateZ(0);
}

button.send-btn:not(:disabled):hover {
  background: #ff3d9e;
  transform: scale(1.05);
}

button.send-btn:disabled {
  background: gray;
  cursor: not-allowed;
  transform: none;
}

/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
#login-container {
  position: absolute;
  inset: 0;
  background: var(--bg-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#login-box {
  background: var(--bg-header);
  padding: 30px;
  border-radius: 10px;
  width: 300px;
  text-align: center;
  animation: popIn 0.3s ease-out;
}

@keyframes popIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

#login-box input {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
  border: none;
  outline: none;
  transition: all 0.2s;
}

#login-box input:focus {
  box-shadow: 0 0 0 2px var(--primary-color);
}

#login-box button {
  width: 100%;
  padding: 10px;
  background: var(--primary-color);
  border: none;
  border-radius: 5px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
}

#login-box button:not(:disabled):hover {
  background: #ff3d9e;
  transform: scale(1.02);
}

#login-box button:disabled {
  background: gray;
  cursor: not-allowed;
  transform: none;
}

#login-error {
  color: #ff5555;
  font-size: 14px;
  min-height: 20px;
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
.call-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  flex-direction: column;
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.call-popup .call-box {
  background: var(--bg-header);
  padding: 30px;
  border-radius: 15px;
  text-align: center;
  width: 300px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.call-popup .call-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--primary-color);
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 30px;
  color: white;
  margin: 0 auto 15px;
}

.call-popup .call-name {
  font-size: 18px;
  margin-bottom: 5px;
  color: var(--secondary-color);
}

.call-popup .call-status {
  font-size: 14px;
  color: #ffabc2;
  margin-bottom: 20px;
}

.call-popup .call-buttons {
  display: flex;
  justify-content: center;
  gap: 20px;
}

.call-popup .call-btn {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.2s;
  transform: translateZ(0);
}

.call-popup .call-btn:hover {
  transform: scale(1.1);
}

.call-popup .accept-btn {
  background: #32cd32;
  color: white;
}

.call-popup .reject-btn {
  background: #ff5555;
  color: white;
}

.call-popup .end-btn {
  background: #ff5555;
  color: white;
}

.call-popup .ringing-animation {
  animation: ring 1.5s infinite;
}

@keyframes ring {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø§Ø±ÙŠ */
.active-call {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-dark);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.2s ease-out;
}

.active-call .call-info {
  text-align: center;
  margin-bottom: 30px;
}

.active-call .call-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: var(--primary-color);
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  font-size: 40px;
  color: white;
  margin: 0 auto 15px;
}

.active-call .call-name {
  font-size: 22px;
  margin-bottom: 5px;
  color: var(--secondary-color);
}

.active-call .call-status {
  font-size: 16px;
  color: #ffabc2;
}

.active-call .call-timer {
  font-size: 18px;
  margin-top: 10px;
  color: white;
  font-family: monospace;
}

.active-call .call-controls {
  display: flex;
  gap: 30px;
  margin-top: 30px;
}

.active-call .call-control-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: none;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.2s;
}

.active-call .call-control-btn:hover {
  transform: scale(1.1);
}

.active-call .end-call-btn {
  background: #ff5555;
  color: white;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ÙˆØ³Ø§Ø¦Ø· */
.message img, .message video {
  max-width: 100%;
  border-radius: 10px;
  margin-top: 5px;
}

/* Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 10px 15px;
  background: white;
  border-radius: 20px;
  align-self: flex-start;
  margin-bottom: 10px;
  max-width: 70px;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #666;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

/* Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
.sending-indicator {
  font-size: 10px;
  color: #999;
  margin-top: 5px;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ */
.optimized-render {
  will-change: transform, opacity;
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 768px) {
  .message {
    max-width: 85%;
  }
  
  #call-btn, #video-btn {
    font-size: 18px;
  }
  
  #video-btn { left: 45px; }
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± */
#chat-messages::-webkit-scrollbar {
  width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
  background: #ff3d9e;
}
</style>
</head>
<body>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="login-container">
  <div id="login-box">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input type="text" id="login-username" placeholder="Ø§Ù„Ø§Ø³Ù…"/>
    <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"/>
    <div id="login-error"></div>
    <button id="login-btn">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<div class="chat-container" id="chat-ui" style="display:none;">
  <header>
    <div class="avatar">Ø­</div>
    <div class="user-info">
      <div class="user-name" id="user-name-display">Ø­Ø¨ÙŠØ¨Ùƒ Ù…Ø²ÙˆÙ†</div>
      <div id="status">ØºÙŠØ± Ù…ØªØµÙ„</div>
    </div>
    <button id="video-btn">ğŸ“½</button>
    <button id="call-btn">ğŸ“</button>
  </header>
  <main>
    <div id="chat-messages"></div>
  </main>
  <footer>
    <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©"/>
    <button class="send-btn" id="send-btn" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
    <input type="file" id="file-input" style="display:none;" />
    <button id="file-btn">ğŸ“</button>
  </footer>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© -->
<div id="incoming-call-popup" class="call-popup" style="display:none;">
  <div class="call-box">
    <div class="call-avatar ringing-animation">Ø­</div>
    <div class="call-name" id="incoming-call-name">Ù…Ø²ÙˆÙ†ÙŠ</div>
    <div class="call-status" id="incoming-call-type">Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ© ÙˆØ§Ø±Ø¯Ø©</div>
    <div class="call-buttons">
      <button class="call-btn reject-btn" id="reject-call-btn">âœ–</button>
      <button class="call-btn accept-btn" id="accept-call-btn">ğŸ“</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµØ§Ø¯Ø± -->
<div id="outgoing-call-popup" class="call-popup" style="display:none;">
  <div class="call-box">
    <div class="call-avatar ringing-animation">Ø­</div>
    <div class="call-name" id="outgoing-call-name">Ù‡Ù†ÙˆØ¯Ù‡</div>
    <div class="call-status" id="outgoing-call-type">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>
    <div class="call-buttons">
      <button class="call-btn end-btn" id="end-outgoing-call-btn">âœ–</button>
    </div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø§Ø±ÙŠ -->
<div id="active-call-popup" class="active-call" style="display:none;">
  <div class="call-info">
    <div class="call-avatar">Ø­</div>
    <div class="call-name" id="active-call-name">Ù‡Ù†ÙˆØ¯Ù‡</div>
    <div class="call-status" id="active-call-type">Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©</div>
    <div class="call-timer" id="call-timer">00:00</div>
  </div>
  <div class="call-controls">
    <button class="call-control-btn end-call-btn" id="end-active-call-btn">âœ–</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
const users = {"Ù…Ø²ÙˆÙ†ÙŠ": "088033", "Ù‡Ù†ÙˆØ¯Ù‡": "239635"};
let username = null;
let peerUsername = null;
const loginContainer = document.getElementById('login-container');
const chatUI = document.getElementById('chat-ui');
const loginBtn = document.getElementById('login-btn');
const loginError = document.getElementById('login-error');
const userNameDisplay = document.getElementById('user-name-display');
const statusDisplay = document.getElementById('status');

// Ø¹Ù†Ø§ØµØ± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„
const incomingCallPopup = document.getElementById('incoming-call-popup');
const outgoingCallPopup = document.getElementById('outgoing-call-popup');
const activeCallPopup = document.getElementById('active-call-popup');
const incomingCallName = document.getElementById('incoming-call-name');
const incomingCallType = document.getElementById('incoming-call-type');
const outgoingCallName = document.getElementById('outgoing-call-name');
const outgoingCallType = document.getElementById('outgoing-call-type');
const activeCallName = document.getElementById('active-call-name');
const activeCallType = document.getElementById('active-call-type');
const callTimer = document.getElementById('call-timer');
const rejectCallBtn = document.getElementById('reject-call-btn');
const acceptCallBtn = document.getElementById('accept-call-btn');
const endOutgoingCallBtn = document.getElementById('end-outgoing-call-btn');
const endActiveCallBtn = document.getElementById('end-active-call-btn');

// ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ - Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
const messageCache = new Map();
let lastMessageTime = 0;
const MESSAGE_THROTTLE = 100; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)

// ØªØ³Ø±ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
loginBtn.addEventListener('click', async () => {
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value.trim();
  
  if (users[u] && users[u] === p) {
    username = u;
    peerUsername = (username === 'Ù…Ø²ÙˆÙ†ÙŠ') ? 'Ù‡Ù†ÙˆØ¯Ù‡' : 'Ù…Ø²ÙˆÙ†ÙŠ';
    
    // ØªØ£Ø«ÙŠØ± ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹
    loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
    loginBtn.disabled = true;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    setTimeout(() => {
      loginContainer.style.display = 'none';
      chatUI.style.display = 'flex';
      userNameDisplay.textContent = peerUsername;
      initChat();
    }, 50);
  } else {
    loginError.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©';
    // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    loginContainer.style.animation = 'shake 0.5s';
    setTimeout(() => loginContainer.style.animation = '', 500);
  }
});

// ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
  }
`;
document.head.appendChild(style);

async function initChat() {
  const firebaseConfig = { 
    databaseURL: "https://fronalsh-app-default-rtdb.firebaseio.com",
    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    appId: "1:123456789:web:abcdef123456",
    projectId: "fronalsh-app"
  };
  
  // ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ø³Ø±Ø¹Ø©
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  
  const db = firebase.database();
  const storage = firebase.storage();
  const messagesRef = db.ref('messages');
  const usersRef = db.ref('users');
  const callsRef = db.ref('calls');
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ø±Ø¹Ø©
  await Promise.all([
    usersRef.child(username).set({ online: true, lastSeen: Date.now() }),
    usersRef.child(username).onDisconnect().set({ online: false, lastSeen: Date.now() })
  ]);
  
  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø± Ù…Ø¹ ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª
  let peerStatusCache = null;
  usersRef.child(peerUsername).on('value', snap => {
    const val = snap.val();
    if (val && peerStatusCache !== val.online) {
      peerStatusCache = val.online;
      statusDisplay.textContent = val.online ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
      statusDisplay.style.color = val.online ? '#32cd32' : '#ffabc2';
    }
  });

  const messages = document.getElementById('chat-messages');
  const input = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const fileBtn = document.getElementById('file-btn');
  const fileInput = document.getElementById('file-input');
  const callBtn = document.getElementById('call-btn');
  const videoBtn = document.getElementById('video-btn');

  // ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  let inputTimeout;
  input.addEventListener('input', () => {
    clearTimeout(inputTimeout);
    inputTimeout = setTimeout(() => {
      sendBtn.disabled = input.value.trim() === '';
    }, 10); // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹
  });

  // ÙˆØ¸ÙŠÙØ© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø©
  function formatTime(ts) {
    const d = new Date(ts);
    return d.getHours() + ":" + (d.getMinutes() < 10 ? '0' : '') + d.getMinutes();
  }

  // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¨Ø³Ø±Ø¹Ø© Ù…Ø¹ ØªØ£Ø«ÙŠØ±
  function addMessage(content, sentByMe, type = 'text', ts = Date.now(), read = false, messageId = null) {
    // Ù…Ù†Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    if (messageId && messageCache.has(messageId)) return;
    if (messageId) messageCache.set(messageId, true);
    
    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    const now = Date.now();
    if (now - lastMessageTime < MESSAGE_THROTTLE) {
      setTimeout(() => addMessage(content, sentByMe, type, ts, read, messageId), 
                 MESSAGE_THROTTLE - (now - lastMessageTime));
      return;
    }
    lastMessageTime = now;

    const div = document.createElement('div');
    div.classList.add('message', 'optimized-render', sentByMe ? 'sent' : 'recv');
    
    let html = '';
    if (type === 'text') html = content;
    if (type === 'image') html = `<img src="${content}" loading="lazy" style="max-width:200px;border-radius:10px;">`;
    if (type === 'video') html = `<video src="${content}" controls preload="metadata" style="max-width:200px;border-radius:10px;"></video>`;
    
    html += `<span class="timestamp">${formatTime(ts)} ${sentByMe ? (read ? 'âœ”âœ”' : 'âœ”') : ''}</span>`;
    div.innerHTML = html;
    
    // Ø¥Ø¶Ø§ÙØ© Ø¨Ø³Ù„Ø§Ø³Ø©
    messages.appendChild(div);
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    requestAnimationFrame(() => {
      messages.scrollTop = messages.scrollHeight;
    });
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø³Ø±Ø¹Ø©
  sendBtn.addEventListener('click', () => {
    const msg = input.value.trim();
    if (msg) {
      // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ (Optimistic UI)
      const tempId = 'temp_' + Date.now();
      addMessage(msg, true, 'text', Date.now(), false, tempId);
      
      const messageData = {
        sender: username,
        type: 'text',
        content: msg,
        timestamp: Date.now(),
        read: false
      };
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      messagesRef.push(messageData)
        .then(() => {
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚Øª Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          messageCache.delete(tempId);
        })
        .catch(error => {
          console.error('Error sending message:', error);
          // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø®Ø·Ø£ Ù‡Ù†Ø§
        });
      
      input.value = '';
      sendBtn.disabled = true;
    }
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø²Ø± Enter
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !sendBtn.disabled) {
      sendBtn.click();
    }
  });

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø³Ø±Ø¹Ø©
  fileBtn.addEventListener('click', () => fileInput.click());
  
  fileInput.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (file) {
      // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„
      const tempId = 'file_' + Date.now();
      addMessage('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...', true, 'text', Date.now(), false, tempId);
      
      try {
        const ref = storage.ref().child('files/' + Date.now() + '_' + file.name);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        const type = file.type.startsWith('image/') ? 'image' : 'video';
        
        messagesRef.push({
          sender: username,
          type: type,
          content: url,
          timestamp: Date.now(),
          read: false
        });
        
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        messageCache.delete(tempId);
      } catch (error) {
        console.error('Error uploading file:', error);
        addMessage('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù', true, 'text', Date.now(), false);
      }
    }
  });

  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø³Ø±Ø¹Ø© Ù…Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
  let lastMessageKey = null;
  messagesRef.orderByChild('timestamp').startAfter(lastMessageKey).on('child_added', snap => {
    const data = snap.val();
    const sentByMe = data.sender === username;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… requestAnimationFrame Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    requestAnimationFrame(() => {
      addMessage(data.content, sentByMe, data.type, data.timestamp, data.read, snap.key);
    });
    
    lastMessageKey = data.timestamp;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    if (!sentByMe) {
      messagesRef.child(snap.key).update({ read: true });
    }
  });

  // ===== WebRTC Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø§Ù„Ø±Ø¯/Ø§Ù„Ø±ÙØ¶ =====
  let pc = null, localStream = null;
  const servers = { 
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' }
    ] 
  };
  let callStartTime = null;
  let callTimerInterval = null;
  let currentCallType = null;

  // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¨Ø³Ø±Ø¹Ø©
  async function requestMediaPermission(video = false) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: video, 
        audio: true 
      });
      stream.getTracks().forEach(track => track.stop());
      return true;
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†:', error);
      return false;
    }
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµØ§Ø¯Ø±
  function showOutgoingCallPopup(video) {
    outgoingCallName.textContent = peerUsername;
    outgoingCallType.textContent = video ? 'Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ø±ÙŠØ©...' : 'Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ© Ø¬Ø§Ø±ÙŠØ©...';
    outgoingCallPopup.style.display = 'flex';
  }

  // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØµØ§Ø¯Ø±
  function hideOutgoingCallPopup() {
    outgoingCallPopup.style.display = 'none';
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯
  function showIncomingCallPopup(from, video) {
    incomingCallName.textContent = from;
    incomingCallType.textContent = video ? 'Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø±Ø¯Ø©' : 'Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ© ÙˆØ§Ø±Ø¯Ø©';
    incomingCallPopup.style.display = 'flex';
  }

  // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯
  function hideIncomingCallPopup() {
    incomingCallPopup.style.display = 'none';
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø§Ø±ÙŠ
  function showActiveCallPopup(video) {
    activeCallName.textContent = peerUsername;
    activeCallType.textContent = video ? 'Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ' : 'Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©';
    callStartTime = Date.now();
    callTimerInterval = setInterval(updateCallTimer, 1000);
    activeCallPopup.style.display = 'flex';
  }

  // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¬Ø§Ø±ÙŠ
  function hideActiveCallPopup() {
    activeCallPopup.style.display = 'none';
    if (callTimerInterval) {
      clearInterval(callTimerInterval);
      callTimerInterval = null;
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
  function updateCallTimer() {
    if (!callStartTime) return;
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    callTimer.textContent = `${minutes}:${seconds}`;
  }

  // Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø³Ø±Ø¹Ø©
  async function startCall(video = false) {
    currentCallType = video;
    
    const permissionGranted = await requestMediaPermission(video);
    if (!permissionGranted) {
      alert('ÙŠØ¬Ø¨ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©');
      return;
    }
    
    showOutgoingCallPopup(video);
    
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ 
        video: video, 
        audio: true 
      });
      
      pc = new RTCPeerConnection(servers);
      
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
      });
      
      pc.ontrack = (e) => {
        const mediaElement = document.createElement(video ? 'video' : 'audio');
        mediaElement.srcObject = e.streams[0];
        mediaElement.autoplay = true;
        mediaElement.controls = true;
        mediaElement.style.maxWidth = '200px';
        mediaElement.style.borderRadius = '10px';
        mediaElement.style.marginTop = '10px';
        
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'recv');
        messageDiv.appendChild(mediaElement);
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
      };
      
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      
      callsRef.child(peerUsername).set({
        from: username,
        offer: offer.toJSON(),
        video: video,
        status: 'calling'
      });
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©:', error);
      hideOutgoingCallPopup();
      alert('ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.');
    }
  }

  // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©
  function endCall() {
    if (pc) {
      pc.close();
      pc = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    
    hideOutgoingCallPopup();
    hideIncomingCallPopup();
    hideActiveCallPopup();
    
    callsRef.child(peerUsername).set({
      from: username,
      status: 'ended'
    });
  }

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
  callsRef.child(username).on('value', async snap => {
    const data = snap.val();
    if (!data) return;
    
    if (data.offer && data.status === 'calling') {
      showIncomingCallPopup(data.from, data.video);
      currentCallType = data.video;
      
      acceptCallBtn.onclick = async () => {
        const permissionGranted = await requestMediaPermission(data.video);
        if (!permissionGranted) {
          alert('ÙŠØ¬Ø¨ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©');
          return;
        }
        
        hideIncomingCallPopup();
        showActiveCallPopup(data.video);
        
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ 
            video: data.video, 
            audio: true 
          });
          
          pc = new RTCPeerConnection(servers);
          
          localStream.getTracks().forEach(track => {
            pc.addTrack(track, localStream);
          });
          
          pc.ontrack = (e) => {
            const mediaElement = document.createElement(data.video ? 'video' : 'audio');
            mediaElement.srcObject = e.streams[0];
            mediaElement.autoplay = true;
            mediaElement.controls = true;
            mediaElement.style.maxWidth = '200px';
            mediaElement.style.borderRadius = '10px';
            mediaElement.style.marginTop = '10px';
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'sent');
            messageDiv.appendChild(mediaElement);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
          };
          
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          
          callsRef.child(data.from).set({
            answer: answer.toJSON(),
            status: 'accepted'
          });
          
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©:', error);
          hideActiveCallPopup();
          alert('ÙØ´Ù„ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.');
        }
      };
      
      rejectCallBtn.onclick = () => {
        hideIncomingCallPopup();
        callsRef.child(data.from).set({
          from: username,
          status: 'rejected'
        });
      };
    }
    
    if (data.answer && data.status === 'accepted') {
      hideOutgoingCallPopup();
      showActiveCallPopup(currentCallType);
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
    
    if (data.status === 'rejected') {
      hideOutgoingCallPopup();
      alert('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† Ù‚Ø¨Ù„ ' + peerUsername);
    }
    
    if (data.status === 'ended') {
      hideActiveCallPopup();
      alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ù† Ù‚Ø¨Ù„ ' + peerUsername);
    }
  });

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  callBtn.addEventListener('click', () => startCall(false));
  videoBtn.addEventListener('click', () => startCall(true));
  endOutgoingCallBtn.addEventListener('click', endCall);
  endActiveCallBtn.addEventListener('click', endCall);

  // ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø¯Ø§Ø¡
  window.addEventListener('beforeunload', () => {
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
    usersRef.child(username).set({ online: false, lastSeen: Date.now() });
  });
}
</script>
</body>
</html>
<meta name="google-site-verification" content="Tub7yzYBSg28Cnb8qypEZk1RLwlbnkuoBRcmbRnepXg" />

